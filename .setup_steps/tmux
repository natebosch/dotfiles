#!/bin/bash

set -e

TARGET_VERSION="3.0"

if [ -x "$(command -v tmux)" ]; then
  CURRENT_VERSION="$(echo "$(tmux -V | cut -c 6-)")"
  if [ "$CURRENT_VERSION" == "$TARGET_VERSION" ]; then
    echo "Already have tmux $CURRENT_VERSION"
    exit
  else
    NEWER="$(printf "$CURRENT_VERSION\n$TARGET_VERSION" | sort -V | tail -n1)"
    if [ "$NEWER" != "$TARGET_VERSION" ]; then
      echo "Already have tmux $CURRENT_VERSION > $TARGET_VERSION"
      exit
    fi
  fi
  echo "Upgrading tmux"
fi

if [ "$(uname)" == "Darwin" ]; then
  if [ -z "$NEWER" ]; then
    ~/.brew/bin/brew install tmux
  else
    ~/.brew/bin/brew upgrade tmux
  fi
else
  echo "Installing libevent-dev from apt"
  sudo apt install libevent-dev
  echo "Installing libcurses-dev from apt"
  sudo apt install libncurses-dev
  echo "Downloading tmux $TARGET_VERSION"
  DOWNLOAD="https://github.com/tmux/tmux/releases/download/"
  wget "$DOWNLOAD/$TARGET_VERSION/tmux-$TARGET_VERSION.tar.gz" \
    -O /tmp/tmux.tar.gz
  cd /tmp
  echo "Extracting tmux"
  tar -xzf tmux.tar.gz
  cd "tmux-$TARGET_VERSION"
  echo "Installing tmux"
  ./configure && make && sudo make install
fi
