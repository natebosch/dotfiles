#!/bin/bash
#
# Find or start a tmux session by name or project.

set -e
shopt -s nullglob

if [[ $# -gt 0 ]]; then
  session="$1"
  shift
else
  mapfile -t sessions < <(tmux ls -F '#{session_name}' 2>/dev/null)
  mapfile -t projects < \
    <(find ~/projects -maxdepth 1 -mindepth 1 -type d -printf '%f\n')
  for session in "${sessions[@]}"; do
    for i in "${!projects[@]}"; do
      if [[ "${projects[i]//./_}" == "$session" ]]; then
        unset 'projects[i]'
      fi
    done
  done
  choice=$( \
    ( \
    printf '%s \033[1;34m*\033[0m\n' "${sessions[@]:-0}"; \
    printf '%s \033[0;33mP\033[0m\n' "${projects[@]}" | sort \
    ) | \
    fzf --ansi \
  )
  session="${choice%??}"
  session_type="${choice:(-1)}"
fi

if [[ "$session_type" == "P" ]]; then
  cd ~/projects/"$session"
  if [[ ! -d ".git" ]]; then
    dirs=(*/)
    if [[ "${#dirs[@]}" -eq "1" && -d "${dirs[0]}/.git" ]]; then
      cd "${dirs[0]}"
    fi
  fi
elif [[ "$session" == "0" ]]; then
  cd
fi


session="${session//./_}"
if ! tmux has-session -t "$session" 2>/dev/null ; then
  TMUX="" tmux -2 new -s "$session" -d "$@"
fi

if [[ -n $TMUX ]]; then
  tmux switch-client -t "$session"
else
  tmux -2 a -t "$session" -d
fi
